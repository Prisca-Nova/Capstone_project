<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Editor | Capstone Project</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .sidebar { transition: all 0.3s ease; }
        .editor { min-height: 400px; }
        .history-item:hover { background-color: #f8fafc; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .modal-overlay { background: rgba(0, 0, 0, 0.5); }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navbar -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <i class="fas fa-file-alt text-2xl text-purple-600 mr-3"></i>
                        <h1 class="text-2xl font-bold text-gray-800">DocEditor Pro</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4" id="authButtons">
                    <!-- Will be populated by JS -->
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Auth Section -->
        <div id="authSection" class="hidden">
            <div class="flex min-h-screen items-center justify-center">
                <div class="w-full max-w-md space-y-8">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold text-gray-900" id="authTitle">Welcome Back</h2>
                        <p class="mt-2 text-gray-600">Manage your documents with ease</p>
                    </div>
                    <div id="authForms" class="bg-white p-8 rounded-xl shadow-lg">
                        <!-- Forms will be populated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- App Section -->
        <div id="appSection" class="hidden">
            <div class="flex gap-8">
                <!-- Sidebar -->
                <div class="w-64 sidebar bg-white rounded-xl shadow p-6">
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Projects</h3>
                        <button onclick="showModal('createProject')" class="w-full btn-primary text-white font-medium py-3 px-4 rounded-lg mb-4 hover:opacity-90 transition">
                            <i class="fas fa-plus mr-2"></i> New Project
                        </button>
                        <div id="projectsList" class="space-y-2">
                            <!-- Projects will be populated here -->
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Document History</h3>
                        <div id="historyList" class="space-y-2 max-h-60 overflow-y-auto">
                            <!-- History will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Main Editor Area -->
                <div class="flex-1">
                    <div class="bg-white rounded-xl shadow p-6">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 id="projectTitle" class="text-2xl font-bold text-gray-800">Select a Project</h2>
                                <p id="projectDescription" class="text-gray-600 mt-1"></p>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="saveDocument()" id="saveBtn" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition disabled:opacity-50">
                                    <i class="fas fa-save mr-2"></i> Save
                                </button>
                                <button onclick="loadHistory()" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition">
                                    <i class="fas fa-history mr-2"></i> View History
                                </button>
                            </div>
                        </div>
                        
                        <!-- Editor -->
                        <div class="editor border border-gray-300 rounded-lg p-4 bg-white">
                            <textarea id="documentContent" rows="20" class="w-full h-full border-0 focus:ring-0 focus:outline-none resize-none" placeholder="Start typing your document here..."></textarea>
                        </div>
                        
                        <!-- Auto-save indicator -->
                        <div class="mt-4 flex items-center text-gray-500 text-sm">
                            <i class="fas fa-sync-alt mr-2"></i>
                            <span>Auto-saves every 30 seconds</span>
                            <span id="lastSaved" class="ml-2"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modals">
        <!-- Create Project Modal -->
        <div id="createProject" class="modal-overlay fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Create New Project</h3>
                    <div class="mt-2">
                        <input type="text" id="projectTitleInput" placeholder="Project Title" class="w-full px-3 py-2 border border-gray-300 rounded-md mb-3">
                        <textarea id="projectDescInput" placeholder="Description" class="w-full px-3 py-2 border border-gray-300 rounded-md mb-4" rows="3"></textarea>
                        <div class="flex justify-end space-x-3">
                            <button onclick="hideModal('createProject')" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                            <button onclick="createProject()" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">Create</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Modal -->
        <div id="historyModal" class="modal-overlay fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-3/4 shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Document History</h3>
                    <button onclick="hideModal('historyModal')" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="historyContent" class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- History items will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg hidden transform transition-transform duration-300 translate-y-full">
        <div class="flex items-center">
            <i id="toastIcon" class="fas fa-info-circle mr-2"></i>
            <span id="toastMessage">Notification message</span>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let currentToken = localStorage.getItem('token');
        let currentProjectId = null;
        let currentDocumentId = null;
        let autoSaveInterval = null;

        // DOM Elements
        const authSection = document.getElementById('authSection');
        const appSection = document.getElementById('appSection');
        const authButtons = document.getElementById('authButtons');
        const authTitle = document.getElementById('authTitle');
        const authForms = document.getElementById('authForms');

        // Initialize
        checkAuth();

        // Auth Functions
        function checkAuth() {
            if (currentToken) {
                showApp();
                loadProjects();
            } else {
                showAuth();
            }
        }

        function showAuth() {
            authSection.classList.remove('hidden');
            appSection.classList.add('hidden');
            showLoginForm();
        }

        function showApp() {
            authSection.classList.add('hidden');
            appSection.classList.remove('hidden');
            authButtons.innerHTML = `
                <span class="text-gray-700" id="userEmail"></span>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition">
                    Logout
                </button>
            `;
            // Get user email from token (simplified)
            try {
                const payload = JSON.parse(atob(currentToken.split('.')[1]));
                document.getElementById('userEmail').textContent = payload.email;
            } catch (e) {
                console.error('Error parsing token:', e);
            }
        }

        function showLoginForm() {
            authTitle.textContent = 'Welcome Back';
            authForms.innerHTML = `
                <form onsubmit="login(event)" class="space-y-6">
                    <div>
                        <label class="block text-gray-700">Email</label>
                        <input type="email" id="loginEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-gray-700">Password</label>
                        <input type="password" id="loginPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <button type="submit" class="w-full btn-primary text-white font-medium py-3 px-4 rounded-lg hover:opacity-90 transition">
                        Sign In
                    </button>
                </form>
                <p class="mt-4 text-center text-gray-600">
                    Don't have an account?
                    <button onclick="showRegisterForm()" class="text-purple-600 hover:text-purple-800 font-medium">
                        Register here
                    </button>
                </p>
            `;
        }

        function showRegisterForm() {
            authTitle.textContent = 'Create Account';
            authForms.innerHTML = `
                <form onsubmit="register(event)" class="space-y-6">
                    <div>
                        <label class="block text-gray-700">Email</label>
                        <input type="email" id="registerEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-gray-700">Username</label>
                        <input type="text" id="registerUsername" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-gray-700">Password</label>
                        <input type="password" id="registerPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <button type="submit" class="w-full btn-primary text-white font-medium py-3 px-4 rounded-lg hover:opacity-90 transition">
                        Create Account
                    </button>
                </form>
                <p class="mt-4 text-center text-gray-600">
                    Already have an account?
                    <button onclick="showLoginForm()" class="text-purple-600 hover:text-purple-800 font-medium">
                        Sign in here
                    </button>
                </p>
            `;
        }

        async function login(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_BASE}/auth/login/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('token', data.access);
                    currentToken = data.access;
                    showToast('Logged in successfully!', 'success');
                    checkAuth();
                } else {
                    showToast('Invalid credentials', 'error');
                }
            } catch (error) {
                showToast('Login failed', 'error');
            }
        }

        async function register(event) {
            event.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;

            try {
                const response = await fetch(`${API_BASE}/auth/register/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('token', data.access);
                    currentToken = data.access;
                    showToast('Account created successfully!', 'success');
                    checkAuth();
                } else {
                    showToast('Registration failed', 'error');
                }
            } catch (error) {
                showToast('Registration failed', 'error');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            currentToken = null;
            currentProjectId = null;
            clearInterval(autoSaveInterval);
            showToast('Logged out successfully', 'info');
            checkAuth();
        }

        // Project Functions
        async function loadProjects() {
            try {
                const response = await fetch(`${API_BASE}/projects/`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const projects = await response.json();
                    const projectsList = document.getElementById('projectsList');
                    projectsList.innerHTML = '';

                    projects.forEach(project => {
                        const projectElement = document.createElement('button');
                        projectElement.className = 'w-full text-left p-3 rounded-lg hover:bg-purple-50 border border-gray-200';
                        projectElement.innerHTML = `
                            <div class="font-medium text-gray-800">${project.title}</div>
                            <div class="text-sm text-gray-500 truncate">${project.description || 'No description'}</div>
                            <div class="text-xs text-gray-400 mt-1">${new Date(project.created_at).toLocaleDateString()}</div>
                        `;
                        projectElement.onclick = () => loadProject(project.id);
                        projectsList.appendChild(projectElement);
                    });

                    if (projects.length > 0) {
                        loadProject(projects[0].id);
                    }
                }
            } catch (error) {
                console.error('Error loading projects:', error);
            }
        }

        async function loadProject(projectId) {
            try {
                const response = await fetch(`${API_BASE}/projects/${projectId}/`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const project = await response.json();
                    currentProjectId = projectId;
                    
                    document.getElementById('projectTitle').textContent = project.title;
                    document.getElementById('projectDescription').textContent = project.description || '';
                    
                    // Load document
                    const docResponse = await fetch(`${API_BASE}/projects/${projectId}/document/`, {
                        headers: getAuthHeaders()
                    });

                    if (docResponse.ok) {
                        const document = await docResponse.json();
                        currentDocumentId = document.id;
                        document.getElementById('documentContent').value = document.content;
                        updateLastSaved(document.last_modified);
                        
                        // Start auto-save
                        startAutoSave();
                        loadHistoryList();
                    }
                }
            } catch (error) {
                console.error('Error loading project:', error);
            }
        }

        async function createProject() {
            const title = document.getElementById('projectTitleInput').value;
            const description = document.getElementById('projectDescInput').value;

            if (!title.trim()) {
                showToast('Project title is required', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/projects/`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ title, description })
                });

                if (response.ok) {
                    hideModal('createProject');
                    showToast('Project created successfully!', 'success');
                    loadProjects();
                    // Clear form
                    document.getElementById('projectTitleInput').value = '';
                    document.getElementById('projectDescInput').value = '';
                }
            } catch (error) {
                showToast('Failed to create project', 'error');
            }
        }

        // Document Functions
        async function saveDocument() {
            if (!currentProjectId) return;

            const content = document.getElementById('documentContent').value;
            
            try {
                const response = await fetch(`${API_BASE}/projects/${currentProjectId}/document/`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    const document = await response.json();
                    updateLastSaved(document.last_modified);
                    showToast('Document saved!', 'success');
                    loadHistoryList();
                }
            } catch (error) {
                showToast('Failed to save document', 'error');
            }
        }

        function startAutoSave() {
            clearInterval(autoSaveInterval);
            autoSaveInterval = setInterval(() => {
                if (currentProjectId) {
                    saveDocument();
                }
            }, 30000); // Auto-save every 30 seconds
        }

        function updateLastSaved(timestamp) {
            const lastSaved = document.getElementById('lastSaved');
            if (timestamp) {
                lastSaved.textContent = `Last saved: ${new Date(timestamp).toLocaleString()}`;
            }
        }

        // History Functions
        async function loadHistoryList() {
            if (!currentDocumentId) return;

            try {
                const response = await fetch(`${API_BASE}/documents/${currentDocumentId}/history/`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const history = await response.json();
                    const historyList = document.getElementById('historyList');
                    historyList.innerHTML = '';

                    history.slice(0, 5).forEach(item => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item p-2 rounded cursor-pointer';
                        historyItem.innerHTML = `
                            <div class="text-sm text-gray-600">${new Date(item.timestamp).toLocaleString()}</div>
                            <div class="text-xs text-gray-400 truncate">${item.content_snapshot.substring(0, 50)}...</div>
                        `;
                        historyItem.onclick = () => restoreVersion(item.content_snapshot);
                        historyList.appendChild(historyItem);
                    });
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        async function loadHistory() {
            if (!currentDocumentId) return;

            try {
                const response = await fetch(`${API_BASE}/documents/${currentDocumentId}/history/`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const history = await response.json();
                    const historyContent = document.getElementById('historyContent');
                    historyContent.innerHTML = '';

                    history.forEach(item => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'border border-gray-200 rounded-lg p-4';
                        historyItem.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <div class="text-sm font-medium text-gray-700">${new Date(item.timestamp).toLocaleString()}</div>
                                <button onclick="restoreVersionFromModal('${item.content_snapshot.replace(/'/g, "\\'")}')" 
                                        class="text-purple-600 hover:text-purple-800 text-sm font-medium">
                                    Restore
                                </button>
                            </div>
                            <div class="text-gray-600 bg-gray-50 p-3 rounded text-sm max-h-32 overflow-y-auto">
                                ${item.content_snapshot.substring(0, 300)}${item.content_snapshot.length > 300 ? '...' : ''}
                            </div>
                        `;
                        historyContent.appendChild(historyItem);
                    });

                    showModal('historyModal');
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        function restoreVersion(content) {
            document.getElementById('documentContent').value = content;
            showToast('Version restored to editor', 'info');
        }

        function restoreVersionFromModal(content) {
            document.getElementById('documentContent').value = content;
            hideModal('historyModal');
            showToast('Version restored to editor', 'info');
        }

        // Helper Functions
        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${currentToken}`
            };
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');

            toastMessage.textContent = message;
            
            // Set icon based on type
            switch(type) {
                case 'success':
                    toastIcon.className = 'fas fa-check-circle mr-2 text-green-400';
                    break;
                case 'error':
                    toastIcon.className = 'fas fa-exclamation-circle mr-2 text-red-400';
                    break;
                default:
                    toastIcon.className = 'fas fa-info-circle mr-2 text-blue-400';
            }

            toast.classList.remove('hidden', 'translate-y-full');
            setTimeout(() => {
                toast.classList.add('translate-y-full');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        // Close modals when clicking outside
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>